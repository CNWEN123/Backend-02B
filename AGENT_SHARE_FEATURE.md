# 股东/代理 - 注册绑定分享链接 & 专属域名绑定 功能文档

## 功能概述

本系统已完整实现股东/代理的注册绑定分享链接和专属域名绑定功能，包括：

1. **注册绑定分享链接**：代理可以通过邀请码绑定新注册用户
2. **专属域名绑定**：代理可以设置专属域名，通过该域名访问自动关联代理

---

## 一、注册绑定分享链接功能

### 1.1 邀请码管理

#### 自动生成邀请码
- **时机**：创建新代理时自动生成8位唯一邀请码
- **格式**：大写字母+数字组合（如：`A3B7C9D2`）
- **唯一性**：系统保证邀请码全局唯一

#### 邀请码显示位置
- **代理列表页**：
  - 路径：层级管理 → 代理管理
  - 列名：分享链接
  - 显示：邀请码 + 复制按钮
  
#### 重新生成邀请码
- **入口**：点击代理列表中的"分享设置"按钮（紫色图标）
- **操作**：在弹窗中点击"重新生成"按钮
- **警告**：会提示"原邀请码将失效"
- **API**：`POST /api/v1/agents/:agent_id/generate-invite-code`

### 1.2 自定义分享链接

#### 默认分享链接格式
```
https://yourdomain.com/register?ref=A3B7C9D2
```

#### 自定义分享链接
- **设置位置**：分享设置弹窗 → 专属分享链接
- **支持**：完整URL格式，可使用自有域名
- **示例**：
  - `https://custom.com/register?ref=A3B7C9D2`
  - `https://agent.example.com/signup?code=A3B7C9D2`
- **验证**：系统自动验证URL格式正确性
- **API**：`PUT /api/v1/agents/:agent_id/invite-url`

### 1.3 注册绑定流程

#### 玩家注册时使用邀请码
1. 玩家通过分享链接访问注册页面（带邀请码参数）
2. 前端调用公开API验证邀请码：
   ```
   GET /api/v1/public/agent-by-invite/:invite_code
   ```
3. 验证通过后，注册时自动绑定到该代理
4. 返回代理信息：代理ID、名称、层级

#### API响应示例
```json
{
  "success": true,
  "data": {
    "agent_id": 123,
    "agent_name": "张代理",
    "level": 3
  }
}
```

---

## 二、专属域名绑定功能

### 2.1 专属域名设置

#### 设置位置（3个入口）

**入口1：新增代理时设置**
- 路径：层级管理 → 代理管理 → 新增代理
- 位置：表单中的"专属域名绑定"区域
- 时机：创建代理时同时设置
- 字段：`custom_domain`（可选）

**入口2：编辑代理时修改**
- 路径：层级管理 → 代理管理 → 点击"编辑"按钮
- 位置：表单中的"专属域名绑定"区域
- 说明：可修改已有专属域名

**入口3：分享设置弹窗**
- 路径：层级管理 → 代理管理 → 点击"分享设置"按钮（紫色图标）
- 位置：弹窗底部的"专属域名绑定"区域
- 功能：最完整的管理界面，包含验证功能

### 2.2 域名格式要求

#### 有效格式示例
```
agent.yourdomain.com
promo.example.com
a1.gaming.site
```

#### 格式验证规则
- 必须是完整域名（包含至少一个点）
- 只能包含字母、数字、连字符
- 必须以字母或数字开头和结尾
- 顶级域名至少2个字符

#### 无效格式示例
```
localhost              ❌ 缺少顶级域名
192.168.1.1           ❌ IP地址不允许
-agent.com            ❌ 不能以连字符开头
agent-.com            ❌ 不能以连字符结尾
```

### 2.3 域名验证流程

#### 验证说明提示
当设置了专属域名但未验证时，系统会显示：

```
⚠️ 域名验证说明
请将域名 agent.yourdomain.com 的CNAME记录指向:
yoursystem.domain.com
```

#### 验证步骤
1. **DNS设置**：在域名服务商处添加CNAME记录
   ```
   记录类型: CNAME
   主机记录: agent
   记录值: yoursystem.domain.com
   TTL: 600（或默认值）
   ```

2. **验证操作**：
   - 点击"验证域名"按钮
   - 系统检查DNS记录（当前为模拟验证）
   - 验证成功后状态变更为"已验证"

3. **验证状态**：
   - 🔸 **待验证**（黄色标识）：域名已设置但未验证
   - ✅ **已验证**（绿色标识）：域名验证通过
   - ❌ **验证失败**（红色标识）：DNS配置错误

#### 验证API
```
POST /api/v1/agents/:agent_id/verify-domain
```

---

## 三、完整操作流程

### 流程1：创建代理并设置分享功能

1. **登录系统**
   - 账号：admin
   - 密码：admin123

2. **进入代理管理**
   - 导航：层级管理 → 代理管理

3. **新增代理**
   - 点击"新增代理"按钮
   - 填写基本信息（账号、密码、昵称、层级等）
   - 填写"专属域名"（可选）：如 `agent1.example.com`
   - 点击"保存"

4. **获取邀请码**
   - 系统自动生成邀请码并提示
   - 在代理列表中可查看邀请码

5. **配置分享链接**
   - 点击代理的"分享设置"按钮
   - 查看自动生成的邀请码
   - 设置自定义分享链接（可选）
   - 设置或验证专属域名
   - 点击"保存设置"

### 流程2：使用邀请码注册玩家

1. **生成分享链接**
   ```
   https://yourdomain.com/register?ref=A3B7C9D2
   ```

2. **玩家访问注册页**
   - 前端解析URL中的 `ref` 参数
   - 调用验证API：`GET /api/v1/public/agent-by-invite/A3B7C9D2`

3. **显示代理信息**
   - 页面显示："您正在通过代理【张代理】的邀请注册"

4. **完成注册**
   - 玩家填写注册信息
   - 提交时自动关联 `agent_id`
   - 新玩家自动绑定到该代理名下

### 流程3：验证专属域名

1. **设置DNS记录**
   - 登录域名服务商控制台
   - 添加CNAME记录指向主系统域名

2. **验证域名**
   - 进入"分享设置"弹窗
   - 点击"验证域名"按钮
   - 等待验证结果

3. **验证成功**
   - 状态变更为"✅ 已验证"
   - 该域名访问将自动关联代理

---

## 四、API接口文档

### 4.1 代理管理API

#### 创建代理（包含专属域名）
```http
POST /api/v1/agents
Content-Type: application/json

{
  "agent_username": "agent001",
  "password": "password123",
  "nickname": "张代理",
  "level": 3,
  "parent_agent_id": 1,
  "custom_domain": "agent.example.com"
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "agent_id": 123,
    "invite_code": "A3B7C9D2"
  }
}
```

#### 更新代理（包含专属域名）
```http
PUT /api/v1/agents/:agent_id
Content-Type: application/json

{
  "custom_domain": "agent.example.com",
  "invite_url": "https://custom.com/register?ref=A3B7C9D2"
}
```

### 4.2 邀请码管理API

#### 生成/重置邀请码
```http
POST /api/v1/agents/:agent_id/generate-invite-code
```

**响应**：
```json
{
  "success": true,
  "message": "邀请码生成成功",
  "data": {
    "invite_code": "B4D7E9F1"
  }
}
```

#### 更新分享链接
```http
PUT /api/v1/agents/:agent_id/invite-url
Content-Type: application/json

{
  "invite_url": "https://custom.com/register?ref=A3B7C9D2"
}
```

### 4.3 域名验证API

#### 验证专属域名
```http
POST /api/v1/agents/:agent_id/verify-domain
```

**响应**：
```json
{
  "success": true,
  "message": "域名验证成功"
}
```

### 4.4 公开API（无需认证）

#### 根据邀请码获取代理信息
```http
GET /api/v1/public/agent-by-invite/:invite_code
```

**示例**：
```http
GET /api/v1/public/agent-by-invite/A3B7C9D2
```

**响应**：
```json
{
  "success": true,
  "data": {
    "agent_id": 123,
    "agent_name": "张代理",
    "level": 3
  }
}
```

**错误响应**：
```json
{
  "success": false,
  "message": "邀请码无效或代理已禁用"
}
```

---

## 五、数据库字段说明

### agents 表新增字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `invite_code` | VARCHAR(20) | 邀请码，8位大写字母+数字，UNIQUE |
| `invite_url` | VARCHAR(500) | 完整分享链接，可自定义 |
| `custom_domain` | VARCHAR(255) | 专属域名 |
| `custom_domain_status` | TINYINT | 域名验证状态：0=未验证 1=已验证 2=验证失败 |
| `custom_domain_verified_at` | DATETIME | 域名验证时间 |

---

## 六、前端UI说明

### 6.1 代理列表页

**新增列**：
- **分享链接**：显示邀请码 + 复制按钮

**新增操作按钮**：
- **分享设置**（紫色图标）：打开分享与域名设置弹窗

### 6.2 新增/编辑代理表单

**新增区域**：
- **专属域名绑定**（橙色背景）
  - 输入框：专属域名
  - 提示：绑定后该域名访问自动关联此代理

### 6.3 分享设置弹窗（最完整的管理界面）

**结构**：
1. **代理信息卡片**（灰色背景）
   - 显示：头像、账号、昵称、层级

2. **注册绑定邀请码区域**（绿色边框）
   - 邀请码输入框（只读，font-mono大号显示）
   - 复制按钮
   - 重新生成按钮（黄色警告样式）
   - 提示：玩家使用此邀请码注册后自动绑定

3. **专属分享链接区域**（蓝色边框）
   - 分享链接输入框
   - 复制按钮
   - 提示：可自定义分享链接，支持自有域名

4. **专属域名绑定区域**（橙色边框）
   - 专属域名输入框
   - 验证状态标识（已验证/待验证）
   - DNS配置说明（仅待验证时显示）
   - 验证域名按钮（绿色，仅待验证时显示）
   - 提示：绑定后该域名访问自动关联此代理

5. **底部操作按钮**
   - 取消
   - 保存设置（蓝色主按钮）

---

## 七、测试建议

### 7.1 功能测试清单

- [ ] **创建代理时自动生成邀请码**
- [ ] **邀请码复制功能正常**
- [ ] **重新生成邀请码成功且原邀请码失效**
- [ ] **自定义分享链接URL格式验证正确**
- [ ] **专属域名格式验证正确**
- [ ] **保存专属域名成功**
- [ ] **域名验证流程正常**
- [ ] **公开API验证邀请码有效性**
- [ ] **编辑代理时可修改专属域名**
- [ ] **代理列表正确显示邀请码**

### 7.2 测试数据

**测试账号**：
```
管理员：admin / admin123
```

**测试代理**：
```
账号：agent001
密码：password123
昵称：测试代理
层级：代理（三级）
专属域名：test.agent.com
```

**测试邀请码**：
```
格式：8位大写字母+数字
示例：A3B7C9D2
```

---

## 八、系统访问信息

**预览地址**：https://3000-i9mzigr2smruxfa8tgrk9-2e77fc33.sandbox.novita.ai

**登录凭证**：
- 用户名：`admin`
- 密码：`admin123`

**功能路径**：
1. 登录系统
2. 导航：**层级管理** → **代理管理**
3. 操作：
   - 点击"新增代理"创建并设置专属域名
   - 点击"编辑"修改专属域名
   - 点击"分享设置"（紫色图标）管理分享链接和域名

---

## 九、注意事项

### 9.1 邀请码管理
- 邀请码全局唯一，不可重复
- 重新生成邀请码会使原邀请码立即失效
- 建议在重新生成前通知使用该邀请码的推广渠道

### 9.2 专属域名
- 域名设置后需要配置DNS才能使用
- 当前验证功能为模拟验证（生产环境需实现真实DNS检查）
- 建议使用二级域名或三级域名，避免使用主域名

### 9.3 分享链接
- 支持任意有效URL格式
- 建议包含邀请码参数便于前端识别
- 可以使用短链接服务

### 9.4 安全建议
- 定期审计邀请码使用情况
- 监控异常注册行为
- 对失效的邀请码进行归档
- 域名验证失败时及时通知代理

---

## 十、未来优化方向

### 10.1 功能增强
- [ ] 邀请码使用统计（已使用次数、成功注册数）
- [ ] 批量生成邀请码
- [ ] 邀请码有效期限制
- [ ] 单个邀请码使用次数限制
- [ ] 分享链接短链接生成
- [ ] 专属域名SSL证书自动配置

### 10.2 数据分析
- [ ] 代理推广效果分析
- [ ] 邀请码转化率统计
- [ ] 专属域名访问量统计
- [ ] 热门分享渠道分析

### 10.3 自动化
- [ ] DNS验证自动化（真实检查CNAME记录）
- [ ] 域名SSL证书自动申请和续期
- [ ] 邀请码自动续期提醒
- [ ] 异常使用自动预警

---

**文档版本**：v1.0  
**最后更新**：2024-11-30  
**系统版本**：Live Dealer Admin V2.1
